#+TITLE: Mercurial チートシート
#+AUTHOR: Takumi IINO (troter)
#+EMAIL: takumi@timedia.co.jp, trot.thunder@gmail.com
#+LANGUAGE: ja

#+OPTIONS: ^:nil toc:2
#+STYLE: <link rel="stylesheet" type="text/css" href="org-mode-document.css" />

* はじめに
mercurialのチートシートが[[https://github.com/troter/troter.github.com/tree/master/mercurial-cheatsheet][github]]に上がっていることに疑問を覚えないこと。

* Mercurialとは
TODO:

* 最初の設定
** 設定ファイルの場所
| Windows                     | Linux/MacOSX/Cygwin |
|-----------------------------+---------------------|
| %USERPROFILE%\Mercurial.ini | $HOME/.hgrc         |

** ユーザ名の設定
設定ファイルに次の項目を追加します。
#+BEGIN_SRC text
[ui]
username=Takumi IINO <takumi@timedia.co.jp>
#+END_SRC

* helpの参照
** help(hg help)
#+BEGIN_SRC sh
% hg help
#+END_SRC
** サブコマンドのhelp(hg help [COMMAND])
#+BEGIN_SRC sh
% hg help [コマンド]
#+END_SRC
#+BEGIN_SRC sh
% hg help help           # helpのhelpを表示
#+END_SRC
** グローバルオプションを表示
hgのオプションに-vを追加する
#+BEGIN_SRC sh
% hg -v help log
#+END_SRC

* リポジトリを用意する
** リポジトリの新規作成(hg init)
#+BEGIN_SRC sh
% mkdir hello
% cd hello
% hg init
#+END_SRC

** リポジトリのクローン(hg clone)
#+BEGIN_SRC sh
% hg clone http://selenic.com/hg mercurial-repo
requesting all changes
adding changesets
adding manifests
adding file changes
added 13537 changesets with 26617 changes to 1971 files
updating to branch default
872 files updated, 0 files merged, 0 files removed, 0 files unresolved
$
#+END_SRC

* 確認を行う
** コミットログを確認する(hg log)
#+BEGIN_SRC sh
% hg log       # 全てのログを表示
% hg log -l 10 # 最新10個のログを表示
% hg log -l 10 --branch default # ブランチを指定してログを表示
#+END_SRC

** サマリー(hg summary)
#+BEGIN_SRC sh
% hg summary
parent: 13536:fac040b7e822 tip
 merge: drop resolve state for mergers with identical contents (issue2680)
branch: default
commit: (clean)
update: (current)
%
#+END_SRC

** 現在のリビジョン(hg parents)
#+BEGIN_SRC sh
% hg parents
changeset:   13536:fac040b7e822
tag:         tip
user:        Matt Mackall <mpm@selenic.com>
date:        Sat Mar 05 16:34:59 2011 -0600
summary:     merge: drop resolve state for mergers with identical contents (issue2680)

%
#+END_SRC

** 最新のリビジョン(hg tip)
#+BEGIN_SRC sh
% hg tip
changeset:   13536:fac040b7e822
tag:         tip
user:        Matt Mackall <mpm@selenic.com>
date:        Sat Mar 05 16:34:59 2011 -0600
summary:     merge: drop resolve state for mergers with identical contents (issue2680)

%
#+END_SRC

** 現在のブランチ(hg branch)
#+BEGIN_SRC sh
% hg branch
default
%
#+END_SRC

** ブランチの一覧とブランチ毎の最新のリビジョン(hg branches)
#+BEGIN_SRC sh
% hg branches
default                    13536:fac040b7e822
stable                     13534:4ec34de8bbb1 (inactive)
%
#+END_SRC

* 移動を行う
** 指定したリビジョンに移動(hg update [REV])
#+BEGIN_SRC sh
% hg update [リビジョン]
#+END_SRC
#+BEGIN_SRC sh
% hg parent --template "{rev}\n"
13536
% hg update 13524 # リビジョン 13524に移動
10 files updated, 0 files merged, 0 files removed, 0 files unresolved
% hg parent --template "{rev}\n"
13524
%
#+END_SRC

** 最新のリビジョンに移動(hg update)
#+BEGIN_SRC sh
% hg update
#+END_SRC
#+BEGIN_SRC sh
% hg parent --template "{rev}\n"
13524
% hg update # 最新のリビジョンに移動
10 files updated, 0 files merged, 0 files removed, 0 files unresolved
% hg parent --template "{rev}\n"
13536
%
#+END_SRC

** ブランチの移動(hg update [BRANCH])
#+BEGIN_SRC sh
% hg update [ブランチ名]
#+END_SRC
#+BEGIN_SRC sh
% hg branch
default
% hg update stable
22 files updated, 0 files merged, 0 files removed, 0 files unresolved
% hg branch
stable
#+END_SRC

* ファイルの操作
操作のための新しいリポジトリを作りましょう
#+BEGIN_SRC sh
% mkdir hello-repo
% cd hello-repo
% hg init
#+END_SRC

** ファイルを追加する(hg add)
#+BEGIN_SRC sh
% echo 'puts "Hello, mercurial."' > hello.rb
% hg add hello.rb
%
#+END_SRC

** コミットする(hg commit)
#+BEGIN_SRC sh
% hg tip
changeset:   -1:000000000000
tag:         tip
user:
date:        Thu Jan 01 00:00:00 1970 +0000

% hg commit -m "add hello.rb"
% hg tip
changeset:   0:c0d1b673238b
tag:         tip
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Sun Mar 06 22:27:01 2011 +0900
summary:     add hello.rb

%
#+END_SRC

** 変更を確認する(hg diff)
#+BEGIN_SRC sh
% sed -i -e s/m/M/ hello.rb
% hg diff
diff -r c0d1b673238b hello.rb
--- a/hello.rb  Sun Mar 06 22:27:01 2011 +0900
+++ b/hello.rb  Sun Mar 06 22:34:35 2011 +0900
@@ -1,1 +1,1 @@
-puts "Hello, mercurial."
+puts "Hello, Mercurial."
%
% # もう一つ追加してみる
% echo 'print "Hello, Mercurial.\n";' > hello.pl
% hg add hello.pl
% hg diff hello.pl
diff -r c0d1b673238b hello.pl
--- /dev/null   Thu Jan 01 00:00:00 1970 +0000
+++ b/hello.pl  Sun Mar 06 22:36:56 2011 +0900
@@ -0,0 +1,1 @@
+print "Hello, Mercurial.\n";
%
#+END_SRC

** 変更されたファイル一覧(hg status)
#+BEGIN_SRC sh
% hg status
M hello.rb
A hello.pl
%
#+END_SRC

** 変更を取り消す(hg revert)
#+BEGIN_SRC sh
% hg revert hello.pl
% hg status
M hello.rb
? hello.pl
%
% hg add hello.pl # またaddしておこう
#+END_SRC

** コミットを取り消す(hg rollback)
#+BEGIN_SRC sh
% hg commit -m "add perl sample" # 二つの変更をコミットしてしまった
% hg diff -c 1
diff -r c0d1b673238b -r 30b4e1e501a3 hello.pl
--- /dev/null   Thu Jan 01 00:00:00 1970 +0000
+++ b/hello.pl  Sun Mar 06 22:42:41 2011 +0900
@@ -0,0 +1,1 @@
+print "Hello, Mercurial.\n";
diff -r c0d1b673238b -r 30b4e1e501a3 hello.rb
--- a/hello.rb  Sun Mar 06 22:27:01 2011 +0900
+++ b/hello.rb  Sun Mar 06 22:42:41 2011 +0900
@@ -1,1 +1,1 @@
-puts "Hello, mercurial."
+puts "Hello, Mercurial."
%
% hg rollback
repository tip rolled back to revision 0 (undo commit)
working directory now based on revision 0
%
% hg commit -m "camelize" hello.rb
% hg commit -m "add perl sample"
%
#+END_SRC
最新のコミットのみrollback可能
#+BEGIN_SRC sh
% hg log --template "{rev}:{node}: {desc}\n"
2:c0266fae871b5783d4f4a50faf0694d41df01418: add perl sample
1:f491ca2a61140034ed906d7d45893838493246c8: camelize
0:c0d1b673238bd257f79a7c2779f1e0d8e24d3524: add hello.rb
%
% hg rollback
repository tip rolled back to revision 1 (undo commit)
working directory now based on revision 1
%
% hg rollback
no rollback information available
%
% hg log --template "{rev}:{node}: {desc}\n"
1:f491ca2a61140034ed906d7d45893838493246c8: camelize
0:c0d1b673238bd257f79a7c2779f1e0d8e24d3524: add hello.rb
%
% hg commit -m "add perl sample"
% hg log --template "{rev}:{node}: {desc}\n"
2:c0266fae871b5783d4f4a50faf0694d41df01418: add perl sample
1:f491ca2a61140034ed906d7d45893838493246c8: camelize
0:c0d1b673238bd257f79a7c2779f1e0d8e24d3524: add hello.rb
%
#+END_SRC

* multiple headsに関わる操作
multiple headsとは名前無しブランチが複数ある状態の事である。
** multiple headsを作る(hg update [REV] & hg commit)
#+BEGIN_SRC sh
% hg log --template "{rev}:{node}: {desc}\n"
2:c0266fae871b5783d4f4a50faf0694d41df01418: add perl sample
1:f491ca2a61140034ed906d7d45893838493246c8: camelize
0:c0d1b673238bd257f79a7c2779f1e0d8e24d3524: add hello.rb
%
% # 一つ前に戻る
% hg update 1
0 files updated, 0 files merged, 1 files removed, 0 files unresolved
% hg parents --template "{rev}:{node}\n"
1:f491ca2a61140034ed906d7d45893838493246c8
%
% # 二つ目のheadsを作る
% echo 'print "Hello, Mercurial."' > hello.py
% hg add hello.py
% hg commit -m "add python sample"
created new head
%
#+END_SRC
** multiple headsの確認(hg heads)
#+BEGIN_SRC sh
% hg heads
changeset:   3:980f8866917a
tag:         tip
parent:      1:f491ca2a6114
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:10:18 2011 +0900
summary:     add python sample

changeset:   2:46f0166b17d8
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Sun Mar 06 22:53:57 2011 +0900
summary:     add perl sample

%
#+END_SRC
** 2つのmultiple headsの統合(hg merge)
#+BEGIN_SRC sh
% hg merge
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)
% hg status
M hello.pl
%
% # この状態でparentsを確認すると二つあることがわかる。
% hg parents --template "{rev}:{node}\n"
3:980f8866917a1098d08f1e1b85dc396fecbc83ad
2:46f0166b17d886637c30e6f486b23043be56b22e
%
% hg commit -m "merge changeset: 2:46f0166b17d8"
% hg heads
changeset:   4:4b83e608a7d0
tag:         tip
parent:      3:980f8866917a
parent:      2:46f0166b17d8
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:17:50 2011 +0900
summary:     merge changeset: 2:46f0166b17d8

% ls
hello.pl  hello.py  hello.rb
%
#+END_SRC
** 3つのmultiple headsの統合(hg merge -r [REV])
*** 3つheadの作成
#+BEGIN_SRC sh
% # 二つ目のheadを作る
% hg update 3
0 files updated, 0 files merged, 1 files removed, 0 files unresolved
% echo '(display "Hello, Mercurial.")(newline)' > hello.scm
% hg add hello.scm
% hg commit -m "add scheme sample"
created new head
%
% # 三つ目のheadを作る
% hg update 3
0 files updated, 0 files merged, 1 files removed, 0 files unresolved
% echo '(princ (format nil "Hello, Mercurial.~%"))' > hello.cl
% hg add hello.cl
% hg commit -m "add common lisp sample"
created new head
%
% hg heads
changeset:   6:6a0eac3064c9
tag:         tip
parent:      3:980f8866917a
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:34:33 2011 +0900
summary:     add common lisp sample

changeset:   5:bcb5dec879f9
parent:      3:980f8866917a
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:22:44 2011 +0900
summary:     add scheme sample

changeset:   4:4b83e608a7d0
parent:      3:980f8866917a
parent:      2:46f0166b17d8
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:17:50 2011 +0900
summary:     merge changeset: 2:46f0166b17d8

%
#+END_SRC

*** 統合
単純なmergeは失敗する
#+BEGIN_SRC sh
% hg merge
abort: branch 'default' has 3 heads - please merge with an explicit rev
(run 'hg heads .' to see heads)
#+END_SRC
リビジョンを指定してmergeを行う
#+BEGIN_SRC sh
% hg parents --template "{rev}:{node}\n"
6:6a0eac3064c9543384538a5f3ce8e28ad21f5db1
%
% # 一つ目のmerge
% hg merge -r 4
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)
%
% # いっぺんに複数のマージは行えない
% hg merge -r 5
abort: outstanding uncommitted merges
%
% # 一つ目をコミット
% hg commit -m "Merged changes"
%
% # 二つ目のmergeとコミット
% hg merge -r 5
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)
% hg commit -m "Merged changes"
%
% # headの統合が完了
% hg heads
changeset:   8:48d139b4230f
tag:         tip
parent:      7:89f3c6e6d974
parent:      5:bcb5dec879f9
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 00:47:37 2011 +0900
summary:     Merged changes

%
#+END_SRC

** 衝突の解決(hg resolve)
*** 衝突するシュチュエーション
二つのheadで別々の修正を行う
#+BEGIN_SRC sh
% hg parents --template "{rev}:{node}\n"
8:48d139b4230f7db36105b605d5f85e01a1b0efb0
%
% echo "all: scm\n\nscm:\n\tgosh hello.scm\n" > Makefile
% hg add Makefile
% hg ci -m "run with gosh"
%
% hg update 8
% echo "all: scm\n\nscm:\n\tguile hello.scm\n" > Makefile
% hg add Makefile
% hg ci -m "run with guile"
%
% hg heads --template "{rev}:{node} {desc}\n"
10:47589976d454f75dc26bd8f99a786fac408e8b14 run with guile
9:821a2430ed2f5607bb5da42ee6ffb77d7a88fa55 run with gosh
%
#+END_SRC
*** 衝突の発生
#+BEGIN_SRC sh
% hg merge
merging Makefile
warning: conflicts during merge.
merging Makefile failed!
0 files updated, 0 files merged, 0 files removed, 1 files unresolved
use 'hg resolve' to retry unresolved file merges or 'hg update -C .' to abandon
%
% hg status
M Makefile        # svnのように C ではない
? Makefile.orig
%
% cat Makefile
all: scm

scm:
<<<<<<< local
        guile hello.scm
=======
        gosh hello.scm
>>>>>>> other

% hg commit -m "解決しないとコミットできない"
abort: unresolved merge conflicts (see hg resolve)
%
#+END_SRC
*** 衝突の解決
#+BEGIN_SRC sh
% # 衝突したファイル一覧
% hg resolve -l
U Makefile
% vi Makefile
% hg diff Makefile
diff -r 47589976d454 Makefile
--- a/Makefile  Mon Mar 07 21:13:58 2011 +0900
+++ b/Makefile  Mon Mar 07 21:42:16 2011 +0900
@@ -1,5 +1,5 @@
 all: scm

 scm:
-       guile hello.scm
+       gosh hello.scm

%
% # 解決済みのマークをつける
% hg resolve -m Makefile
% hg resolve -l
R Makefile
%
% # コミット
% hg commit -m "guileがelispを置き換えるなら考える"
% hg heads
changeset:   11:1597cc35cade
tag:         tip
parent:      10:47589976d454
parent:      9:821a2430ed2f
user:        Takumi IINO <takumi@timedia.co.jp>
date:        Mon Mar 07 21:52:53 2011 +0900
summary:     guileがelispを置き換えるなら考える

%
#+END_SRC
* ブランチの操作
** ブランチの作成(hg branch [NAME])
** "別のブランチ"の変更の取り込み(hg merge)
** "別のリポジトリの同じブランチ"の変更の取り込み(hg pull -U)
** "別のリポジトリの同じブランチ"へ変更の送信(hg push)
** ブランチを閉じる(hg commit --close-branch)
* タグの操作
** タグをつける(hg tag)
* 用語
- tip :: 最新のリビジョンの事
- defaultブランチ :: svnのtrunk、gitのmasterの事
- multiple heads :: 名前無しブランチが複数できている状態の事

* 参考文献
- [[http://mercurial.selenic.com/wiki/JapaneseBeginnersGuides][初心者向けガイド]]
- [[http://foozy.bitbucket.org/hgbook-ja/index.ja.html][hgbook 日本語版]]
- [[http://beproud.bitbucket.org/bpmercurial-workflow/ja/][BPMERCURIAL-WORKFLOW ドキュメント]]
- [[http://www.geocities.jp/km_pp1/org-mode/org-mode-document.html][Org-mode による HTML 文書作成入門]]
